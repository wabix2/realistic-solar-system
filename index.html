<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3D Realistic Solar System ‚Äî Full Edition</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; color:#fff; font-family: system-ui, Arial, sans-serif; }
    #app { position:fixed; inset:0; }
    /* HUD (left top) */
    #hud {
      position: fixed; left: 16px; top: 16px; z-index: 10; background: rgba(0,0,0,.5);
      border: 1px solid rgba(255,255,255,.15); border-radius: 12px; padding: 12px 14px; backdrop-filter: blur(4px);
      max-width: 380px;
    }
    #hud h1 { font-size: 16px; margin: 0 0 6px; font-weight: 700; }
    #hud .row { display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin-top:6px; }
    #hud label { font-size: 12px; opacity:.9; }
    #hud input[type=range] { width: 170px; }
    #hud button {
      background:#ffc800; color:#000; border:0; border-radius:10px; padding:6px 10px; font-weight:700; cursor:pointer;
    }
    #hud button:hover { background:#ffb700; }
    #hud .toggles { display:grid; grid-template-columns: 1fr 1fr; gap:6px 16px; margin-top:6px; }
    /* Info panel (right) */
    #panel {
      position: fixed; right: 16px; top: 16px; z-index: 10; background: rgba(0,0,0,.5);
      border: 1px solid rgba(255,255,255,.15); border-radius: 12px; padding: 12px 14px; width: 280px; backdrop-filter: blur(4px);
    }
    #panel h2 { font-size: 16px; margin: 0 0 6px; }
    #panel p { margin: 6px 0; font-size: 13px; line-height: 1.35; opacity:.95; }
    #panel .small { opacity:.7; font-size: 12px; }
    #panel .actions { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    #panel button {
      background:#1ea7fd; color:#000; border:0; border-radius:10px; padding:6px 10px; font-weight:700; cursor:pointer;
    }
    #panel button:hover { background:#0fa2ff; }
    #thumb { width:100%; height:auto; border-radius:10px; border:1px solid rgba(255,255,255,.12); display:none; margin-top:8px; }

    /* Labels */
    .label {
      color:#fff; font-size: 12px;
      text-shadow: 0 0 8px #000, 0 0 2px #000;
      transform: translate(-50%, -50%);
      position: absolute; pointer-events:none; white-space: nowrap;
    }

    /* Credit */
    #credit {
      position: fixed; left: 16px; bottom: 12px; font-size: 11px; opacity: .7; user-select:none;
      background: rgba(0,0,0,.35); padding: 6px 8px; border-radius: 8px; border:1px solid rgba(255,255,255,.12);
    }

    @media (max-width: 900px){
      #panel { width: 240px; }
      #hud { max-width: 330px; }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- Controls -->
  <div id="hud">
    <h1>üåû 3D Realistic Solar System ‚Äî Full Edition</h1>
    <div class="row">
      <button id="toggle">‚è∏Ô∏è Pause</button>
      <label for="speed">Speed</label>
      <input id="speed" type="range" min="0" max="3" step="0.01" value="1" />
      <label id="speedVal">1.00√ó</label>
    </div>
    <div class="toggles">
      <label><input type="checkbox" id="showOrbits" checked /> Show orbits</label>
      <label><input type="checkbox" id="showLabels" checked /> Show labels</label>
      <label><input type="checkbox" id="showTrails" /> Motion trails</label>
      <label><input type="checkbox" id="elliptical" /> Elliptical demo</label>
      <label><input type="checkbox" id="showComet" checked /> Show comet</label>
      <label><input type="checkbox" id="autoTour" /> Auto tour</label>
    </div>
  </div>

  <!-- Planet/Moon info -->
  <div id="panel">
    <h2 id="pName">Click an object</h2>
    <img id="thumb" alt="thumbnail" />
    <p class="small">Tip: rotate with mouse/touch, scroll to zoom, right-drag to pan.</p>
    <p id="pFacts">Select a planet, moon, or comet to see details here.</p>
    <div class="actions">
      <button id="focusBtn" disabled>üîé Focus</button>
      <button id="unfocusBtn" disabled>‚Ü© Reset</button>
      <button id="centerBtn">‚òÄÔ∏è Go to Sun</button>
    </div>
  </div>

  <div id="credit">Textures ¬© threejs.org examples / NASA ¬∑ Built with Three.js</div>

  <!-- Three.js from CDN -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    // ---------- Scene setup ----------
    const container = document.getElementById('app');
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    container.appendChild(renderer.domElement);

    const scene = new THREE.Scene();

    // Background stars (inverted sphere)
    const starTex = new THREE.TextureLoader().load('https://threejs.org/examples/textures/planets/starfield.jpg');
    const starGeo = new THREE.SphereGeometry(6000, 64, 64);
    const starMat = new THREE.MeshBasicMaterial({ map: starTex, side: THREE.BackSide });
    scene.add(new THREE.Mesh(starGeo, starMat));

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 20000);
    camera.position.set(0, 240, 520);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    // Lights: bright sun + faint ambient
    const sunLight = new THREE.PointLight(0xffffff, 2.2, 0);
    sunLight.position.set(0,0,0);
    scene.add(sunLight);
    scene.add(new THREE.AmbientLight(0x111111));

    // ---------- Sun ----------
    const loader = new THREE.TextureLoader();
    const sunTex = loader.load('https://threejs.org/examples/textures/planets/sun.jpg');
    const sun = new THREE.Mesh(new THREE.SphereGeometry(30, 64, 64), new THREE.MeshBasicMaterial({ map: sunTex }));
    sun.userData = { type:'star', key:'Sun', info:{
      radiusKm: 696340, description: 'The Sun is a G-type main-sequence star that powers the Solar System.',
      image: 'https://upload.wikimedia.org/wikipedia/commons/c/c3/Solar_sys8.jpg'
    }};
    scene.add(sun);

    // ---------- Scales ----------
    const distanceScale = 50; // orbital distance multiplier
    const sizeScale = 1.2;    // planet size multiplier

    // ---------- Data ----------
    const PLANETS = [
      { key:'Mercury', tex:'https://threejs.org/examples/textures/planets/mercury.jpg', radiusKm:2440,  radius:2.4*sizeScale, distance:0.39*distanceScale, periodY:0.24, tiltDeg:0.01, rotHours:1407.6, image:'https://upload.wikimedia.org/wikipedia/commons/4/4a/Mercury_in_true_color.jpg' },
      { key:'Venus',   tex:'https://threejs.org/examples/textures/planets/venus.jpg',   radiusKm:6052,  radius:6.0*sizeScale, distance:0.72*distanceScale, periodY:0.62, tiltDeg:177,  rotHours:-5832.5, image:'https://upload.wikimedia.org/wikipedia/commons/e/e5/Venus-real_color.jpg' },
      { key:'Earth',   tex:'https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg', radiusKm:6371,  radius:6.4*sizeScale, distance:1.00*distanceScale, periodY:1.00, tiltDeg:23.4, rotHours:23.93, image:'https://upload.wikimedia.org/wikipedia/commons/9/97/The_Earth_seen_from_Apollo_17.jpg',
        moons: [
          { key:'Moon', radiusKm:1737, radius:1.75*sizeScale, distance: 10, periodDays:27.3, tex:'https://threejs.org/examples/textures/planets/moon_1024.jpg', image:'https://upload.wikimedia.org/wikipedia/commons/e/e1/FullMoon2010.jpg' }
        ]
      },
      { key:'Mars',    tex:'https://threejs.org/examples/textures/planets/mars_1k_color.jpg',    radiusKm:3390,  radius:3.4*sizeScale, distance:1.52*distanceScale, periodY:1.88, tiltDeg:25,   rotHours:24.62, image:'https://upload.wikimedia.org/wikipedia/commons/0/02/OSIRIS_Mars_true_color.jpg' },
      { key:'Jupiter', tex:'https://threejs.org/examples/textures/planets/jupiter2_1024.jpg',    radiusKm:69911, radius:71.0*sizeScale/10, distance:5.20*distanceScale, periodY:11.86, tiltDeg:3,   rotHours:9.93, image:'https://upload.wikimedia.org/wikipedia/commons/e/e2/Jupiter.jpg',
        moons: [
          { key:'Io',        radiusKm:1821, radius:1.9*sizeScale,  distance: 14, periodDays:1.77, tex:'https://upload.wikimedia.org/wikipedia/commons/7/7b/PIA01125_Io_true_color.jpg', image:'https://upload.wikimedia.org/wikipedia/commons/7/7b/PIA01125_Io_true_color.jpg' },
          { key:'Europa',    radiusKm:1560, radius:1.7*sizeScale,  distance: 18, periodDays:3.55, tex:'https://upload.wikimedia.org/wikipedia/commons/5/54/Europa-moon.jpg', image:'https://upload.wikimedia.org/wikipedia/commons/5/54/Europa-moon.jpg' },
          { key:'Ganymede',  radiusKm:2634, radius:2.2*sizeScale,  distance: 23, periodDays:7.15, tex:'https://upload.wikimedia.org/wikipedia/commons/5/5a/Ganymede_-_August_29_2021.png', image:'https://upload.wikimedia.org/wikipedia/commons/5/5a/Ganymede_-_August_29_2021.png' },
          { key:'Callisto',  radiusKm:2410, radius:2.1*sizeScale,  distance: 28, periodDays:16.69, tex:'https://upload.wikimedia.org/wikipedia/commons/8/83/Callisto.jpg', image:'https://upload.wikimedia.org/wikipedia/commons/8/83/Callisto.jpg' }
        ]
      },
      { key:'Saturn',  tex:'https://threejs.org/examples/textures/planets/saturn.jpg',          radiusKm:58232, radius:60.0*sizeScale/10, distance:9.58*distanceScale, periodY:29.46, tiltDeg:27,  rotHours:10.7, rings:true, ringTex:'https://threejs.org/examples/textures/planets/saturnringcolor.jpg', image:'https://upload.wikimedia.org/wikipedia/commons/c/c7/Saturn_during_Equinox.jpg' },
      { key:'Uranus',  tex:'https://threejs.org/examples/textures/planets/uranus.jpg',          radiusKm:25362, radius:25.0*sizeScale/10, distance:19.2*distanceScale, periodY:84.0,  tiltDeg:97,  rotHours:-17.2, rings:true, ringTex:'https://threejs.org/examples/textures/planets/uranus_ring.png', image:'https://upload.wikimedia.org/wikipedia/commons/3/3d/Uranus2.jpg' },
      { key:'Neptune', tex:'https://threejs.org/examples/textures/planets/neptune.jpg',         radiusKm:24622, radius:24.0*sizeScale/10, distance:30.1*distanceScale, periodY:164.8, tiltDeg:28,  rotHours:16.1, image:'https://upload.wikimedia.org/wikipedia/commons/5/56/Neptune_Full.jpg' }
    ];

    // Thumbnail fallbacks
    const IMAGE_FALLBACK = 'https://upload.wikimedia.org/wikipedia/commons/6/6f/Deep_Space.jpg';

    // ---------- Helpers ----------
    function makeOrbit(radius){
      const segments = 256;
      const geo = new THREE.BufferGeometry();
      const pos = new Float32Array((segments+1)*3);
      for(let i=0;i<=segments;i++){
        const t = (i/segments)*Math.PI*2;
        pos[i*3+0] = Math.cos(t)*radius;
        pos[i*3+1] = 0;
        pos[i*3+2] = Math.sin(t)*radius;
      }
      geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
      return new THREE.Line(geo, new THREE.LineBasicMaterial({ color:0x444444, transparent:true, opacity:0.65 }));
    }

    const labelsContainer = document.createElement('div');
    labelsContainer.style.position = 'fixed';
    labelsContainer.style.inset = '0';
    labelsContainer.style.pointerEvents = 'none';
    document.body.appendChild(labelsContainer);

    function makeLabel(text){
      const el = document.createElement('div');
      el.className = 'label';
      el.textContent = text;
      labelsContainer.appendChild(el);
      return el;
    }

    // Trails: simple buffered line per object
    function Trail(maxPoints=600){
      const geo = new THREE.BufferGeometry();
      const positions = new Float32Array(maxPoints*3);
      geo.setAttribute('position', new THREE.BufferAttribute(positions,3));
      const mat = new THREE.LineBasicMaterial({ color:0x88aaff, transparent:true, opacity:0.6 });
      const line = new THREE.Line(geo, mat);
      line.frustumCulled = false;
      return { line, positions, maxPoints, head:0, filled:false };
    }
    function pushTrail(trail, v){
      const i = trail.head % trail.maxPoints;
      trail.positions[i*3+0] = v.x;
      trail.positions[i*3+1] = v.y;
      trail.positions[i*3+2] = v.z;
      trail.head++;
      if (trail.head >= trail.maxPoints) trail.filled = true;
      const attr = trail.line.geometry.getAttribute('position');
      attr.needsUpdate = true;
      trail.line.geometry.setDrawRange(0, trail.filled ? trail.maxPoints : trail.head);
    }
    function clearTrail(trail){
      trail.head = 0; trail.filled = false;
      trail.line.geometry.setDrawRange(0, 0);
    }

    // ---------- Build system (planets, moons) ----------
    const objects = []; // clickable: {type, key, mesh, def, orbit, angle, label, trail?}
    const planetGroups = []; // to manage moons relative orbits

    PLANETS.forEach(planet => {
      const group = new THREE.Group(); // center at sun, holds planet + moons
      scene.add(group);

      const pMat = new THREE.MeshPhongMaterial({ map: loader.load(planet.tex) });
      const pMesh = new THREE.Mesh(new THREE.SphereGeometry(planet.radius, 48, 48), pMat);
      pMesh.rotation.z = (planet.tiltDeg||0)*Math.PI/180;
      pMesh.position.set(planet.distance, 0, 0);
      group.add(pMesh);

      // Rings
      if (planet.rings){
        const ringTex = loader.load(planet.ringTex);
        const ring = new THREE.Mesh(
          new THREE.RingGeometry(planet.radius*1.6, planet.radius*2.5, 128),
          new THREE.MeshBasicMaterial({ map: ringTex, side: THREE.DoubleSide, transparent:true, opacity:0.9 })
        );
        ring.rotation.x = Math.PI/2;
        pMesh.add(ring);
      }

      // Orbit line around Sun
      const orbit = makeOrbit(planet.distance);
      scene.add(orbit);

      // Label
      const label = makeLabel(planet.key);

      // Trail
      const trail = Trail(700);
      scene.add(trail.line);

      const entry = { type:'planet', key:planet.key, mesh:pMesh, def:planet, orbit, angle: Math.random()*Math.PI*2, label, group, trail };
      pMesh.userData = entry;
      objects.push(entry);
      planetGroups.push(entry);

      // Moons
      if (planet.moons){
        planet.moons.forEach(moon => {
          const mTex = moon.tex ? loader.load(moon.tex) : null;
          const mMat = mTex ? new THREE.MeshPhongMaterial({ map:mTex }) : new THREE.MeshPhongMaterial({ color:0xaaaaaa });
          const mMesh = new THREE.Mesh(new THREE.SphereGeometry(moon.radius, 36, 36), mMat);
          mMesh.position.set(planet.distance + moon.distance, 0, 0);
          scene.add(mMesh); // Keep world-anchored for simpler trails (we update absolute pos each frame)

          const mOrbit = makeOrbit(planet.distance + moon.distance);
          scene.add(mOrbit);

          const mLabel = makeLabel(moon.key);
          const mTrail = Trail(500);
          scene.add(mTrail.line);

          const mEntry = { type:'moon', parent:entry, key:moon.key, mesh:mMesh, def:{...moon, image: moon.image||IMAGE_FALLBACK}, orbit:mOrbit, angle:Math.random()*Math.PI*2, label:mLabel, trail:mTrail };
          mMesh.userData = mEntry;
          objects.push(mEntry);
        });
      }
    });

    // ---------- Comet (Halley-style) ----------
    const comet = {
      key:'Comet Halley',
      perihelion: 0.6*distanceScale,
      aphelion: 35*distanceScale,
      inclination: 162 * Math.PI/180, // retrograde-ish
      periodY: 75, radius: 1.5*sizeScale,
      tex: 'https://upload.wikimedia.org/wikipedia/commons/1/1f/Comet_Halley_-_1986.jpg',
      image: 'https://upload.wikimedia.org/wikipedia/commons/1/1f/Comet_Halley_-_1986.jpg'
    };

    // Comet nucleus
    const cometMat = new THREE.MeshPhongMaterial({ color:0xffffff });
    const cometMesh = new THREE.Mesh(new THREE.SphereGeometry(comet.radius, 24, 24), cometMat);
    scene.add(cometMesh);
    const cometLabel = makeLabel('Comet Halley');

    // Simple tail as particle billboards along velocity direction
    const tailCount = 200;
    const tailGeom = new THREE.BufferGeometry();
    const tailPos = new Float32Array(tailCount*3);
    tailGeom.setAttribute('position', new THREE.BufferAttribute(tailPos,3));
    const tailMat = new THREE.PointsMaterial({ color:0x99ccff, size: 1.6, transparent:true, opacity:0.9 });
    const tailPoints = new THREE.Points(tailGeom, tailMat);
    scene.add(tailPoints);

    const cometTrail = Trail(900);
    scene.add(cometTrail.line);

    // ---------- UI wiring ----------
    const btn = document.getElementById('toggle');
    const speedRange = document.getElementById('speed');
    const speedVal = document.getElementById('speedVal');
    const showOrbits = document.getElementById('showOrbits');
    const showLabels = document.getElementById('showLabels');
    const showTrails = document.getElementById('showTrails');
    const elliptical = document.getElementById('elliptical');
    const showComet = document.getElementById('showComet');
    const autoTour = document.getElementById('autoTour');

    let playing = true;
    let speedMultiplier = parseFloat(speedRange.value);
    speedVal.textContent = speedMultiplier.toFixed(2)+'√ó';

    btn.addEventListener('click', () => {
      playing = !playing;
      btn.textContent = playing ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Play';
    });
    speedRange.addEventListener('input', e => {
      speedMultiplier = parseFloat(e.target.value);
      speedVal.textContent = speedMultiplier.toFixed(2)+'√ó';
    });
    showOrbits.addEventListener('change', () => {
      objects.forEach(o => o.orbit && (o.orbit.visible = showOrbits.checked));
    });
    showLabels.addEventListener('change', () => {
      objects.forEach(o => o.label.style.display = showLabels.checked ? 'block' : 'none');
      cometLabel.style.display = showLabels.checked && showComet.checked ? 'block' : 'none';
    });
    showTrails.addEventListener('change', () => {
      if (!showTrails.checked){
        objects.forEach(o => o.trail && clearTrail(o.trail));
        clearTrail(cometTrail);
      }
    });
    showComet.addEventListener('change', () => {
      cometMesh.visible = showComet.checked;
      tailPoints.visible = showComet.checked;
      cometLabel.style.display = (showComet.checked && showLabels.checked) ? 'block' : 'none';
      cometTrail.line.visible = (showComet.checked && showTrails.checked);
    });

    // ---------- Info panel ----------
    const pName = document.getElementById('pName');
    const pFacts = document.getElementById('pFacts');
    const focusBtn = document.getElementById('focusBtn');
    const unfocusBtn = document.getElementById('unfocusBtn');
    const centerBtn = document.getElementById('centerBtn');
    const thumb = document.getElementById('thumb');

    let selected = null;
    function setSelected(obj){
      selected = obj;
      if (!obj){
        pName.textContent = 'Click an object';
        pFacts.textContent = 'Select a planet, moon, or comet to see details here.';
        thumb.style.display = 'none';
        focusBtn.disabled = true;
        unfocusBtn.disabled = true;
        return;
      }
      pName.textContent = obj.key;
      const d = obj.def || obj.info || {};
      const radiusKm = d.radiusKm ? `${d.radiusKm.toLocaleString()} km` : (obj.type==='comet' ? '~5‚Äì15 km (nucleus)' : '‚Äî');
      const semiAU = (d.distance ? (d.distance/distanceScale).toFixed(2)+' AU' :
                       obj.type==='comet' ? `q‚âà${(comet.perihelion/distanceScale).toFixed(2)} AU, Q‚âà${(comet.aphelion/distanceScale).toFixed(1)} AU` :
                       '‚Äî');
      const period = d.periodY ? `${d.periodY} Earth years` : (d.periodDays ? `${d.periodDays} days` : (obj.type==='comet' ? `${comet.periodY} years` : '‚Äî'));
      const tilt = d.tiltDeg != null ? `${d.tiltDeg}¬∞` : '‚Äî';
      const rot = d.rotHours != null ? `${Math.abs(d.rotHours)} hours ${d.rotHours<0?'(retrograde)':''}` : (obj.type==='comet' ? '‚Äî' : '‚Äî');

      pFacts.innerHTML =
        `<b>Type:</b> ${obj.type[0].toUpperCase()+obj.type.slice(1)}<br>` +
        `<b>Mean radius:</b> ${radiusKm}<br>` +
        `<b>Semi-major axis:</b> ${semiAU}<br>` +
        `<b>Orbital period:</b> ${period}<br>` +
        `<b>Axial tilt:</b> ${tilt}<br>` +
        `<b>Rotation:</b> ${rot}`;

      const imgUrl = d.image || IMAGE_FALLBACK;
      thumb.src = imgUrl;
      thumb.style.display = 'block';

      focusBtn.disabled = false;
      unfocusBtn.disabled = false;
    }

    function focusOnSelected(){
      if (!selected) return;
      const target = selected.mesh.getWorldPosition(new THREE.Vector3());
      controls.target.copy(target);
      const dir = new THREE.Vector3().subVectors(camera.position, target).normalize();
      camera.position.copy(target.clone().add(dir.multiplyScalar( (selected.def?.radius||2)*12 + 40 )));
    }
    function resetView(){
      controls.target.set(0,0,0);
      camera.position.set(0, 240, 520);
    }
    function focusSun(){
      controls.target.set(0,0,0);
      const dir = new THREE.Vector3(0,0,1);
      camera.position.copy(dir.multiplyScalar(140));
    }
    focusBtn.addEventListener('click', focusOnSelected);
    unfocusBtn.addEventListener('click', resetView);
    centerBtn.addEventListener('click', focusSun);

    // ---------- Click picking ----------
    function onPointer(ev){
      const rect = renderer.domElement.getBoundingClientRect();
      mouse.x = ((ev.clientX - rect.left) / rect.width) * 2 - 1;
      mouse.y = -((ev.clientY - rect.top) / rect.height) * 2 + 1;
      raycaster.setFromCamera(mouse, camera);
      const meshes = objects.map(o => o.mesh).concat([sun, cometMesh]);
      const hits = raycaster.intersectObjects(meshes, false);
      if (hits.length){
        const hit = hits[0].object;
        if (hit === sun){
          setSelected(sun.userData);
        } else if (hit === cometMesh){
          setSelected({ type:'comet', key:comet.key, mesh:cometMesh, def:{}, info:{}, label:cometLabel });
        } else {
          setSelected(hit.userData);
        }
      }
    }
    renderer.domElement.addEventListener('pointerdown', onPointer);

    // ---------- Animation ----------
    const clock = new THREE.Clock();

    // For comet parametric position (simple Kepler-like approximation)
    let cometAngle = Math.random()*Math.PI*2;
    function cometPos(t){
      // elliptical radius as function of angle (polar form): r = a(1 - e^2) / (1 + e cos Œ∏)
      const a = (comet.perihelion + comet.aphelion)/2;
      const e = (comet.aphelion - comet.perihelion)/(comet.aphelion + comet.perihelion);
      const r = (a*(1 - e*e)) / (1 + e*Math.cos(cometAngle));
      // rotate plane by inclination
      const x = r*Math.cos(cometAngle);
      const z = r*Math.sin(cometAngle);
      const y = Math.sin(comet.inclination) * z;
      const z2 = Math.cos(comet.inclination) * z;
      return new THREE.Vector3(x, y, z2);
    }

    function updateLabels(){
      objects.forEach(o => {
        const pos = o.mesh.getWorldPosition(new THREE.Vector3());
        const proj = pos.clone().project(camera);
        const x = (proj.x * 0.5 + 0.5) * window.innerWidth;
        const y = (-proj.y * 0.5 + 0.5) * window.innerHeight;
        o.label.style.left = x + 'px';
        o.label.style.top = y + 'px';
        o.label.style.display = showLabels.checked ? 'block' : 'none';
      });
      // comet label
      const cpos = cometMesh.getWorldPosition(new THREE.Vector3()).clone().project(camera);
      const cx = (cpos.x * 0.5 + 0.5) * window.innerWidth;
      const cy = (-cpos.y * 0.5 + 0.5) * window.innerHeight;
      cometLabel.style.left = cx + 'px';
      cometLabel.style.top = cy + 'px';
      cometLabel.style.display = (showLabels.checked && showComet.checked) ? 'block' : 'none';
    }

    window.addEventListener('resize', () => {
      renderer.setSize(window.innerWidth, window.innerHeight);
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
    });

    // Auto tour (focuses each planet briefly)
    let tourIdx = 0, tourTimer = 0;
    function autoTourStep(dt){
      if (!autoTour.checked) return;
      tourTimer -= dt;
      if (tourTimer <= 0){
        const candidates = objects.filter(o => o.type==='planet');
        const target = candidates[tourIdx % candidates.length];
        setSelected(target);
        focusOnSelected();
        tourIdx++;
        tourTimer = 6; // seconds per stop
      }
    }

    function animate(){
      requestAnimationFrame(animate);
      const dt = clock.getDelta();

      if (playing){
        // Planets
        planetGroups.forEach(o => {
          const year = o.def.periodY;
          const angVel = (2*Math.PI) / (year*20); // tuned rate
          o.angle += angVel * dt * speedMultiplier;
          // Position
          if (elliptical.checked){
            const a = o.def.distance*1.0, b = o.def.distance*0.92;
            o.mesh.position.set(Math.cos(o.angle)*a, 0, Math.sin(o.angle)*b);
          } else {
            o.mesh.position.set(Math.cos(o.angle)*o.def.distance, 0, Math.sin(o.angle)*o.def.distance);
          }
          // Self-rotation
          const spin = (2*Math.PI) / (Math.abs(o.def.rotHours) || 24);
          o.mesh.rotation.y += Math.sign(o.def.rotHours || 1) * spin * dt * 0.5;

          // Planet trail
          if (showTrails.checked){
            pushTrail(o.trail, o.mesh.getWorldPosition(new THREE.Vector3()));
          }
          o.trail.line.visible = showTrails.checked;
        });

        // Moons (absolute orbit around sun for simpler labels/trails)
        objects.forEach(o => {
          if (o.type!=='moon') return;
          const parent = o.parent;
          const days = o.def.periodDays || 28;
          const angVel = (2*Math.PI) / (days/10); // sped up for visibility
          o.angle += angVel * dt * speedMultiplier;
          const base = parent.mesh.position;
          const r = (parent.def.distance) + o.def.distance;
          o.mesh.position.set(base.x + Math.cos(o.angle)*o.def.distance, 0, base.z + Math.sin(o.angle)*o.def.distance);

          // moon trail
          if (showTrails.checked){
            pushTrail(o.trail, o.mesh.getWorldPosition(new THREE.Vector3()));
          }
          o.trail.line.visible = showTrails.checked;

          // show/hide moon orbits with global toggle
          o.orbit.visible = showOrbits.checked;
        });

        // Comet
        if (showComet.checked){
          const cometVel = (2*Math.PI)/(comet.periodY*20);
          cometAngle += cometVel * dt * speedMultiplier * 4; // faster for fun
          const p = cometPos(cometAngle);
          cometMesh.position.copy(p);

          // Tail: place points behind direction of motion
          const pPrev = cometPos(cometAngle - 0.02);
          const dir = new THREE.Vector3().subVectors(p, pPrev).normalize();
          for (let i=tailCount-1; i>0; i--){
            tailPos[i*3+0] = tailPos[(i-1)*3+0];
            tailPos[i*3+1] = tailPos[(i-1)*3+1];
            tailPos[i*3+2] = tailPos[(i-1)*3+2];
          }
          tailPos[0] = p.x - dir.x*3; tailPos[1] = p.y - dir.y*3; tailPos[2] = p.z - dir.z*3;
          tailGeom.attributes.position.needsUpdate = true;

          // comet trail
          if (showTrails.checked){
            pushTrail(cometTrail, p);
          }
          cometTrail.line.visible = showTrails.checked;
        }
      } else {
        // paused -> do nothing
      }

      autoTourStep(dt);
      controls.update();
      renderer.render(scene, camera);
      updateLabels();
    }
    animate();

    // Defaults visibility
    objects.forEach(o => o.orbit && (o.orbit.visible = showOrbits.checked));
    objects.forEach(o => o.label.style.display = showLabels.checked ? 'block' : 'none');
    cometMesh.visible = showComet.checked;
    tailPoints.visible = showComet.checked;
    cometLabel.style.display = (showLabels.checked && showComet.checked) ? 'block' : 'none';
    cometTrail.line.visible = (showComet.checked && showTrails.checked);
  </script>
</body>
</html>
